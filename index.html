<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거창 회중 게시판</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#F0F2F5]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            X, Maximize2, Minimize2, FileText, Image as ImageIcon, 
            Download, Plus, Trash2, Edit2, Lock, Save, Upload, Loader, 
            CheckCircle, ArrowRight, Pin, Users, Shield, Calendar, ChevronRight, AlertTriangle 
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query 
        } from 'firebase/firestore';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from 'firebase/auth';

        // -----------------------------------------------------------
        // [시스템] Firebase 초기화 (환경 변수 사용)
        // -----------------------------------------------------------
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'senior-friendly-board';

        // --- 커스텀 아이콘 (왕국회관) ---
        const KingdomHallIcon = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M2 8h20" />
                <path d="M5 8v13h14v-13" />
                <rect x="8" y="13" width="4" height="8" />
                <rect x="14" y="11" width="5" height="5" />
                <path d="M15.5 12.5v2a0.5 0.5 0 0 1 -0.5 0.5" strokeWidth="1.5" />
                <path d="M17 12.5l0.5 2.5l0.5 -2.5l0.5 2.5l0.5 -2.5" strokeWidth="1.5" />
            </svg>
        );

        // --- 유틸리티 ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200; // 해상도 상향 조정
                        const scaleSize = MAX_WIDTH / img.width;
                        const finalScale = scaleSize < 1 ? scaleSize : 1;
                        canvas.width = img.width * finalScale;
                        canvas.height = img.height * finalScale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // 품질 조정
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (err) => reject(err);
            });
        };

        const formatDateFriendly = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const days = ['(일)', '(월)', '(화)', '(수)', '(목)', '(금)', '(토)'];
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${days[date.getDay()]}`;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [documents, setDocuments] = useState([]);
            const [events, setEvents] = useState([]);
            const [loginState, setLoginState] = useState('logged_out'); 
            const [passwordInput, setPasswordInput] = useState('');
            const [loginError, setLoginError] = useState('');

            const [activeDoc, setActiveDoc] = useState(null);
            const [viewMode, setViewMode] = useState('normal'); 
            const [isMobile, setIsMobile] = useState(false);
            const [currentTime, setCurrentTime] = useState('');

            const [isEditMode, setIsEditMode] = useState(false);
            const [editTab, setEditTab] = useState('notice');
            const [editingDoc, setEditingDoc] = useState(null);
            const [editingEvent, setEditingEvent] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);

            const [showAllEvents, setShowAllEvents] = useState(false);

            // [인증] 초기화 및 상태 감지
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth failed:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            // [시간] 실시간 시계
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentTime(`${now.getMonth() + 1}월 ${now.getDate()}일`);
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // [데이터] Firestore 구독
            useEffect(() => {
                if (!user) return;
                
                // 공지사항
                const noticeRef = collection(db, 'artifacts', appId, 'public', 'data', 'notice_board');
                const unsubNotice = onSnapshot(noticeRef, (snapshot) => {
                    let docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // 필터링: 전도인은 장로 전용 제외
                    if (loginState === 'publisher') {
                        docs = docs.filter(doc => doc.targetAudience !== 'elder');
                    }
                    // 정렬: 고정 게시물 우선 -> 최신순
                    docs.sort((a, b) => {
                        if (!!a.isPinned === !!b.isPinned) {
                            return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                        }
                        return a.isPinned ? -1 : 1;
                    });
                    setDocuments(docs);
                }, (err) => console.log("Notice Error", err));

                // 일정
                const schedRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedule_board');
                const unsubSched = onSnapshot(schedRef, (snapshot) => {
                    let evts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // 정렬: 날짜순
                    evts.sort((a, b) => new Date(a.date) - new Date(b.date));
                    // 필터링: 지난 일정 제외 (옵션)
                    const today = new Date().toISOString().split('T')[0];
                    evts = evts.filter(e => e.date >= today);
                    setEvents(evts);
                }, (err) => console.log("Schedule Error", err));

                return () => { unsubNotice(); unsubSched(); };
            }, [user, loginState]);

            useEffect(() => {
                const checkMobile = () => setIsMobile(window.innerWidth < 768);
                checkMobile();
                window.addEventListener('resize', checkMobile);
                return () => window.removeEventListener('resize', checkMobile);
            }, []);

            // --- Handlers ---
            const handleLogin = (e) => {
                e.preventDefault();
                // 패스워드 로직 (클라이언트 사이드 게이트)
                if (passwordInput === '1935') {
                    setLoginState('publisher'); setLoginError('');
                } else if (passwordInput === '00191400') {
                    setLoginState('elder'); setLoginError('');
                } else if (passwordInput === 'givemecourage') {
                    setLoginState('admin'); setLoginError('');
                } else {
                    setLoginError('비밀번호가 올바르지 않습니다.'); setPasswordInput('');
                }
            };

            const handleDelete = async (e, docId, collectionName) => {
                e.stopPropagation();
                if (!window.confirm('정말 삭제하시겠습니까?')) return;
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId));
                    if (collectionName === 'notice_board' && activeDoc?.id === docId) setActiveDoc(null);
                } catch (err) { alert('삭제 실패'); }
            };

            const handleTogglePin = async (e, docData) => {
                e.stopPropagation();
                if (!user) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'notice_board', docData.id);
                    await updateDoc(docRef, { isPinned: !docData.isPinned });
                } catch (err) { alert('고정 실패'); }
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                // 용량 제한 체크
                if (file.size > 5 * 1024 * 1024) { alert('파일 크기는 5MB 이하여야 합니다.'); return; }

                setIsProcessing(true);
                try {
                    let base64String = "";
                    let fileType = "image";
                    if (file.type.includes('image')) {
                        base64String = await compressImage(file); fileType = "image";
                    } else if (file.type.includes('pdf')) {
                        if (file.size > 2 * 1024 * 1024) { alert('PDF는 2MB 이하여야 합니다.'); setIsProcessing(false); return; }
                        base64String = await readFileAsBase64(file); fileType = "pdf";
                    } else {
                        alert('이미지나 PDF만 가능합니다.'); setIsProcessing(false); return;
                    }
                    setEditingDoc(prev => ({
                        ...prev, url: base64String, type: fileType, fileName: file.name, title: prev.title || file.name.replace(/\.[^/.]+$/, "")
                    }));
                } catch (err) { alert('파일 처리 오류'); } finally { setIsProcessing(false); }
            };

            const handleSave = async (e) => {
                e.preventDefault();
                if (!user) { alert("로그인이 필요합니다."); return; }
                setIsProcessing(true);
                try {
                    if (editTab === 'notice') {
                        if (!editingDoc.title || !editingDoc.url || !editingDoc.targetAudience) {
                            alert('필수 정보를 입력해주세요.'); setIsProcessing(false); return;
                        }
                        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'notice_board');
                        const docData = { ...editingDoc, updatedAt: serverTimestamp() };
                        if (editingDoc.id) {
                            const { id, ...updateData } = docData;
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notice_board', editingDoc.id), updateData);
                        } else {
                            await addDoc(collectionRef, { ...docData, createdAt: serverTimestamp() });
                        }
                    } else {
                        if (!editingEvent.title || !editingEvent.date) {
                            alert('필수 정보를 입력해주세요.'); setIsProcessing(false); return;
                        }
                        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'schedule_board');
                        const evtData = { ...editingEvent, updatedAt: serverTimestamp() };
                        await addDoc(collectionRef, { ...evtData, createdAt: serverTimestamp() });
                    }
                    setIsEditMode(false);
                    setEditingDoc(null);
                    setEditingEvent(null);
                } catch (err) {
                    if (err.message.includes("larger than")) {
                        alert("파일 용량이 너무 큽니다. (1MB 제한)");
                    } else {
                        alert('저장 실패: ' + err.message);
                    }
                } finally {
                    setIsProcessing(false);
                }
            };

            const getViewerStyles = () => {
                const baseStyle = "fixed transition-all duration-500 cubic-bezier(0.16, 1, 0.3, 1) bg-white shadow-2xl overflow-hidden border border-slate-200 z-50 flex flex-col";
                if (viewMode === 'minimized') {
                    return isMobile 
                        ? `${baseStyle} bottom-0 left-0 right-0 h-20 rounded-t-2xl border-t-2 border-[#4A6FA5]`
                        : `${baseStyle} bottom-6 right-6 w-96 h-20 rounded-2xl border-2`;
                }
                if (viewMode === 'fullscreen') { return `${baseStyle} inset-0 rounded-none`; }
                if (isMobile) { return `${baseStyle} bottom-0 left-0 right-0 h-[92vh] rounded-t-3xl shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.3)]`; }
                else { return `${baseStyle} bottom-8 right-8 w-[650px] h-[85vh] max-h-[900px] rounded-2xl shadow-2xl`; }
            };

            const eventLimit = loginState === 'admin' ? 5 : 3;

            // [화면 1: 로그인]
            if (loginState === 'logged_out') {
                return (
                    <div className="min-h-screen relative flex items-center justify-center p-6 bg-[#F0F2F5]">
                        <div className="bg-white rounded-3xl shadow-lg border border-slate-100 w-full max-w-sm overflow-hidden animate-in fade-in zoom-in-95 duration-500">
                            <div className="p-8 flex flex-col items-center">
                                <div className="bg-[#4A6FA5] text-white p-5 rounded-full mb-6 shadow-md transform scale-110">
                                    <KingdomHallIcon size={40} />
                                </div>
                                <h2 className="text-2xl font-bold text-[#2C3E50] mb-1">거창 회중 게시판</h2>
                                <p className="text-sm text-slate-500 font-medium mb-8">- 계획표 및 일정 확인 -</p>
                                <form onSubmit={handleLogin} className="w-full space-y-4">
                                    <div className="space-y-2">
                                        <input type="password" inputMode="numeric" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} placeholder="비밀번호 입력" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 text-center text-lg font-bold text-slate-700 placeholder:text-slate-400 focus:ring-2 focus:ring-[#4A6FA5] focus:bg-white transition-all outline-none" autoFocus />
                                    </div>
                                    {loginError && <div className="text-red-500 text-xs font-bold text-center bg-red-50 py-2 rounded-lg">{loginError}</div>}
                                    <button type="submit" className="w-full bg-[#4A6FA5] hover:bg-[#3B5B8C] text-white py-3.5 rounded-xl font-bold text-lg shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">시작</button>
                                </form>
                                <div className="mt-6 flex flex-col items-center gap-2 text-xs text-slate-400 font-medium bg-slate-50 p-3 rounded-lg w-full">
                                    <div className="flex items-center gap-1"><Lock size={12} /> 관리자로부터 받은 비밀번호를 입력하세요</div>
                                </div>
                            </div>
                            <div className="h-1.5 w-full bg-gradient-to-r from-[#4A6FA5] to-[#6B8E23]" />
                        </div>
                    </div>
                );
            }

            // [화면 2: 메인]
            return (
                <div className="min-h-screen bg-[#F0F2F5] text-slate-800 pb-32 font-sans">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                        <div className="px-5 py-5 flex justify-between items-center max-w-6xl mx-auto">
                            <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                <h1 className="text-2xl md:text-3xl font-extrabold text-[#2C3E50] tracking-tight flex items-center gap-3">
                                    <span className="bg-[#4A6FA5] text-white p-2 rounded-xl shadow-sm"><KingdomHallIcon size={32} /></span>
                                    게시판
                                </h1>
                                <div className="flex items-center">
                                    {loginState === 'admin' && <span className="text-sm font-bold bg-red-100 text-red-600 px-3 py-1 rounded-full border border-red-200">관리자 모드</span>}
                                    {loginState === 'elder' && <span className="text-sm font-bold bg-purple-100 text-purple-600 px-3 py-1 rounded-full border border-purple-200">장로</span>}
                                    {loginState === 'publisher' && <span className="text-sm font-bold bg-slate-100 text-slate-600 px-3 py-1 rounded-full border border-slate-200">전도인</span>}
                                </div>
                            </div>
                            <div className="flex items-center gap-3 md:gap-4">
                                <span className="text-sm md:text-base font-bold text-slate-600 bg-slate-100 px-4 py-2 rounded-xl hidden sm:block shadow-sm border border-slate-200">{currentTime}</span>
                                <button onClick={() => setLoginState('logged_out')} className="text-sm font-bold text-slate-500 hover:text-[#4A6FA5] hover:bg-slate-50 border border-slate-200 px-4 py-2.5 rounded-xl transition-all active:scale-95">나가기</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 md:p-8 space-y-8 animate-fade-in">
                        {/* 1. Event Section */}
                        <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <h2 className="text-lg font-extrabold text-[#2C3E50] flex items-center gap-2">
                                    <Calendar size={20} className="text-[#4A6FA5]" />
                                    예정된 이벤트
                                </h2>
                                {events.length > eventLimit && (
                                    <button onClick={() => setShowAllEvents(true)} className="text-sm font-bold text-slate-500 hover:text-[#4A6FA5] flex items-center gap-1">
                                        더보기 <ChevronRight size={14} />
                                    </button>
                                )}
                            </div>
                            
                            <div className="divide-y divide-slate-100">
                                {events.length === 0 ? (
                                    <div className="p-8 text-center text-slate-400 text-sm font-medium">예정된 행사가 없습니다.</div>
                                ) : (
                                    events.slice(0, eventLimit).map((evt) => (
                                        <div key={evt.id} className="px-6 py-4 hover:bg-slate-50 transition-colors flex justify-between items-start group">
                                            <div className="flex-1">
                                                <div className="text-sm text-slate-500 font-medium mb-1 flex items-center gap-2">
                                                    {formatDateFriendly(evt.date)}
                                                    {evt.date === new Date().toISOString().split('T')[0] && <span className="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold">오늘</span>}
                                                </div>
                                                <h3 className="text-lg font-bold text-[#4A6FA5]">{evt.title}</h3>
                                                {evt.desc && <p className="text-sm text-slate-600 mt-1">{evt.desc}</p>}
                                            </div>
                                            {loginState === 'admin' && (
                                                <button onClick={(e) => handleDelete(e, evt.id, 'schedule_board')} className="text-slate-300 hover:text-red-500 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={16} /></button>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        </section>

                        {/* 2. Board Section */}
                        <section>
                            <div className="mb-4 flex items-center gap-2 px-1">
                                <FileText size={20} className="text-[#4A6FA5]" />
                                <h2 className="text-lg font-extrabold text-[#2C3E50]">게시판</h2>
                            </div>

                            {documents.length === 0 ? (
                                <div className="flex flex-col items-center justify-center py-16 text-slate-400 bg-white rounded-2xl border border-slate-200 border-dashed shadow-sm">
                                    <FileText size={32} className="mb-2 text-slate-300" />
                                    <p className="font-bold">게시물이 없습니다</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                                    {documents.map((doc) => (
                                        <div 
                                            key={doc.id}
                                            onClick={() => { setActiveDoc(doc); setViewMode('normal'); }}
                                            className={`
                                                group relative bg-white rounded-xl overflow-hidden border shadow-sm 
                                                hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer
                                                ${activeDoc?.id === doc.id ? 'ring-2 ring-[#4A6FA5] ring-offset-2' : ''}
                                                ${doc.isPinned ? 'border-[#4A6FA5] ring-1 ring-[#4A6FA5]/20' : 'border-slate-100'}
                                            `}
                                        >
                                            <div className="aspect-video bg-slate-100 relative overflow-hidden">
                                                {doc.type === 'pdf' ? (
                                                    <div className="w-full h-full flex flex-col items-center justify-center bg-slate-50 text-[#4A6FA5]">
                                                        <FileText size={32} />
                                                        <span className="mt-1 font-bold text-[10px] bg-white px-1.5 py-0.5 rounded shadow-sm">PDF</span>
                                                    </div>
                                                ) : (
                                                    <img src={doc.url} alt={doc.title} className="w-full h-full object-cover" loading="lazy" />
                                                )}
                                                <div className="absolute top-2 left-2 bg-white/90 backdrop-blur-md px-1.5 py-0.5 rounded-md text-[9px] font-bold shadow-sm text-slate-700 flex items-center gap-1">
                                                    <span className="w-1 h-1 rounded-full bg-[#6B8E23]" />{doc.date}
                                                </div>
                                                {doc.targetAudience === 'elder' && (
                                                    <div className="absolute top-2 right-2 bg-purple-600 text-white px-1.5 py-0.5 rounded-md text-[9px] font-bold shadow-md z-10 flex items-center gap-0.5"><Shield size={8} /> 장로</div>
                                                )}
                                                {doc.isPinned && doc.targetAudience !== 'elder' && (
                                                    <div className="absolute top-2 right-2 bg-[#4A6FA5] text-white p-1 rounded-full shadow-lg z-10"><Pin size={10} fill="currentColor" /></div>
                                                )}
                                            </div>
                                            <div className={`p-3 ${doc.isPinned ? 'bg-blue-50/10' : ''}`}>
                                                <div className="flex items-center gap-1 mb-1">
                                                    {doc.isPinned && <span className="text-[9px] font-bold bg-[#4A6FA5] text-white px-1 py-0.5 rounded shrink-0">공지</span>}
                                                    <h3 className="text-sm font-bold text-[#2C3E50] leading-tight truncate">{doc.title}</h3>
                                                </div>
                                            </div>
                                            {loginState === 'admin' && (
                                                <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20 bg-black/5 p-1 rounded-lg backdrop-blur-sm">
                                                    <button onClick={(e) => handleTogglePin(e, doc)} className={`p-1.5 rounded-md shadow-sm backdrop-blur ${doc.isPinned ? 'bg-[#4A6FA5] text-white' : 'bg-white text-slate-600 hover:text-[#4A6FA5]'}`}><Pin size={16} fill={doc.isPinned ? "currentColor" : "none"} /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); setEditingDoc(doc); setEditTab('notice'); setIsEditMode(true); }} className="bg-white text-slate-600 p-1.5 rounded-md shadow-sm hover:text-[#4A6FA5]"><Edit2 size={16} /></button>
                                                    <button onClick={(e) => handleDelete(e, doc.id, 'notice_board')} className="bg-white text-slate-600 p-1.5 rounded-md shadow-sm hover:text-red-500 hover:bg-red-50"><Trash2 size={16} /></button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>
                    </main>

                    {/* Floating Action Button (Admin Only) */}
                    {loginState === 'admin' && (
                        <button
                            onClick={() => {
                                setEditingDoc({ title: '', type: 'image', desc: '', url: '', fileName: '', date: new Date().toISOString().split('T')[0], targetAudience: null });
                                setEditingEvent({ title: '', date: new Date().toISOString().split('T')[0], desc: '' });
                                setIsEditMode(true);
                                setEditTab('notice');
                            }}
                            className="fixed bottom-8 right-6 md:right-10 z-30 bg-[#2C3E50] text-white p-4 rounded-full shadow-2xl hover:bg-[#1a252f] hover:scale-110 active:scale-95 transition-all"
                        >
                            <Plus size={28} />
                        </button>
                    )}

                    {/* Modal: Edit/Add */}
                    {isEditMode && (
                        <div className="fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto">
                                <div className="flex border-b border-slate-100 sticky top-0 z-10 bg-white">
                                    <button onClick={() => setEditTab('notice')} className={`flex-1 py-4 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${editTab === 'notice' ? 'text-[#4A6FA5] border-b-2 border-[#4A6FA5] bg-blue-50/20' : 'text-slate-400 hover:text-slate-600'}`}><ImageIcon size={18} /> 게시물 (사진/문서)</button>
                                    <button onClick={() => setEditTab('event')} className={`flex-1 py-4 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${editTab === 'event' ? 'text-[#4A6FA5] border-b-2 border-[#4A6FA5] bg-blue-50/20' : 'text-slate-400 hover:text-slate-600'}`}><Calendar size={18} /> 새 일정 추가</button>
                                </div>
                                <form onSubmit={handleSave} className="p-6 space-y-5">
                                    {editTab === 'notice' ? (
                                        <>
                                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                                <label className="block text-sm font-bold text-[#2C3E50] mb-3 flex items-center gap-2"><Users size={16} /> 누가 볼 수 있나요? <span className="text-red-500">*</span></label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button type="button" onClick={() => setEditingDoc({...editingDoc, targetAudience: 'public'})} className={`p-3 rounded-xl text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all ${editingDoc.targetAudience === 'public' ? 'bg-white border-2 border-[#4A6FA5] text-[#4A6FA5] shadow-md' : 'bg-white border border-slate-200 text-slate-400 hover:bg-slate-100'}`}><Users size={20} /> 모두 (전도인)</button>
                                                    <button type="button" onClick={() => setEditingDoc({...editingDoc, targetAudience: 'elder'})} className={`p-3 rounded-xl text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all ${editingDoc.targetAudience === 'elder' ? 'bg-white border-2 border-purple-600 text-purple-600 shadow-md' : 'bg-white border border-slate-200 text-slate-400 hover:bg-slate-100'}`}><Shield size={20} /> 장로 전용</button>
                                                </div>
                                            </div>
                                            <div className="relative">
                                                <input type="file" accept="image/*,application/pdf" onChange={handleFileChange} disabled={isProcessing} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                                <div className={`border-2 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center transition-all duration-300 ${editingDoc.url ? 'border-[#4A6FA5] bg-blue-50/30' : 'border-slate-300 bg-slate-50 hover:bg-slate-100'}`}>
                                                    {isProcessing ? <div className="flex flex-col items-center text-[#4A6FA5]"><Loader size={32} className="animate-spin mb-2" /><span className="font-bold">처리 중...</span></div> : editingDoc.url ? <div className="flex items-center gap-3 w-full"><div className="w-16 h-16 bg-white rounded-lg shadow-sm overflow-hidden flex items-center justify-center border border-slate-200 shrink-0">{editingDoc.type === 'pdf' ? <FileText size={24} className="text-[#4A6FA5]" /> : <img src={editingDoc.url} className="w-full h-full object-cover" alt="preview" />}</div><div className="flex-1 min-w-0"><div className="text-green-600 font-bold text-sm flex items-center gap-1 mb-1"><CheckCircle size={14} /> 선택 완료</div><p className="text-xs text-slate-500 truncate">{editingDoc.fileName}</p></div></div> : <div className="flex flex-col items-center text-slate-400 py-4"><Upload size={32} className="text-slate-300 mb-2" /><span className="font-bold text-slate-600">사진 / 문서 추가</span></div>}
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">제목</label><input type="text" required value={editingDoc.title} onChange={(e) => setEditingDoc({...editingDoc, title: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-base font-bold text-[#2C3E50] focus:ring-2 focus:ring-[#4A6FA5] outline-none" placeholder="제목을 입력하세요" /></div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">날짜</label><input type="date" required value={editingDoc.date} onChange={(e) => setEditingDoc({...editingDoc, date: e.target.value})} className="w-full px-3 py-3 bg-slate-50 border-none rounded-xl font-bold text-[#2C3E50] focus:ring-2 focus:ring-[#4A6FA5] outline-none" /></div>
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">설명 (선택)</label><input type="text" value={editingDoc.desc} onChange={(e) => setEditingDoc({...editingDoc, desc: e.target.value})} className="w-full px-3 py-3 bg-slate-50 border-none rounded-xl text-[#2C3E50] focus:ring-2 focus:ring-[#4A6FA5] outline-none" placeholder="내용" /></div>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="space-y-4 py-4">
                                                <div className="bg-[#4A6FA5]/10 p-4 rounded-xl flex items-center gap-3">
                                                    <Calendar className="text-[#4A6FA5]" size={24} />
                                                    <div><h4 className="font-bold text-[#4A6FA5]">새로운 일정 추가</h4><p className="text-xs text-slate-500">순회 대회, 기념식 등 주요 행사를 입력하세요.</p></div>
                                                </div>
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">행사명</label><input type="text" required value={editingEvent.title} onChange={(e) => setEditingEvent({...editingEvent, title: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-lg font-bold text-[#4A6FA5] focus:ring-2 focus:ring-[#4A6FA5] outline-none" placeholder="예: 순회 대회" /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">날짜</label><input type="date" required value={editingEvent.date} onChange={(e) => setEditingEvent({...editingEvent, date: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border-none rounded-xl font-bold text-slate-800 focus:ring-2 focus:ring-[#4A6FA5] outline-none" /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1.5 ml-1">추가 정보 (선택)</label><input type="text" value={editingEvent.desc} onChange={(e) => setEditingEvent({...editingEvent, desc: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-slate-700 focus:ring-2 focus:ring-[#4A6FA5] outline-none" placeholder="장소, 시간 등 상세 정보" /></div>
                                            </div>
                                        </>
                                    )}
                                    <div className="pt-2"><button type="submit" disabled={isProcessing || (editTab === 'notice' && !editingDoc.targetAudience)} className={`w-full py-4 rounded-xl font-bold text-lg flex justify-center items-center gap-2 transition-all shadow-lg active:scale-95 ${isProcessing || (editTab === 'notice' && !editingDoc.targetAudience) ? 'bg-slate-300 text-slate-500 cursor-not-allowed' : 'bg-[#2C3E50] hover:bg-[#1a252f] text-white'}`}><Save size={18} /> 등록하기</button></div>
                                </form>
                                <button onClick={() => setIsEditMode(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-500"><X size={20} /></button>
                            </div>
                        </div>
                    )}

                    {/* Modal: Show All Events */}
                    {showAllEvents && (
                        <div className="fixed inset-0 bg-slate-900/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
                                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                                    <h3 className="font-extrabold text-lg text-[#2C3E50]">전체 일정 목록</h3>
                                    <button onClick={() => setShowAllEvents(false)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><X size={20} /></button>
                                </div>
                                <div className="overflow-y-auto p-4 space-y-2">
                                    {events.map((evt) => (
                                        <div key={evt.id} className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div className="text-sm font-bold text-slate-500 mb-1">{formatDateFriendly(evt.date)}</div>
                                            <h4 className="text-lg font-bold text-[#4A6FA5]">{evt.title}</h4>
                                            {evt.desc && <p className="text-sm text-slate-600 mt-1">{evt.desc}</p>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Viewer */}
                    {activeDoc && (
                        <>
                            {isMobile && viewMode === 'normal' && <div className="fixed inset-0 bg-black/60 z-40 backdrop-blur-sm transition-opacity" onClick={() => setViewMode('minimized')} />}
                            <div className={getViewerStyles()}>
                                <div className="flex items-center justify-between px-5 py-4 bg-white border-b border-slate-100 cursor-pointer" onClick={() => setViewMode(viewMode === 'minimized' ? 'normal' : 'minimized')}>
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className="bg-[#4A6FA5] p-1.5 rounded-lg text-white shrink-0">{activeDoc.type === 'pdf' ? <FileText size={16} /> : <ImageIcon size={16} />}</div>
                                        <h3 className="font-bold text-[#2C3E50] text-lg truncate pr-4">{activeDoc.title}</h3>
                                        {activeDoc.targetAudience === 'elder' && <span className="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full border border-purple-200 shrink-0">장로 전용</span>}
                                    </div>
                                    <div className="flex items-center gap-2 text-slate-400">
                                        <button onClick={(e) => { e.stopPropagation(); setViewMode(viewMode === 'fullscreen' ? 'normal' : 'fullscreen'); }} className="p-2 hover:bg-slate-100 rounded-lg transition-colors hidden md:block">{viewMode === 'fullscreen' ? <Minimize2 size={20} /> : <Maximize2 size={20} />}</button>
                                        <button onClick={(e) => { e.stopPropagation(); setActiveDoc(null); }} className="p-2 bg-slate-100 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors text-slate-600"><X size={20} /></button>
                                    </div>
                                </div>
                                <div className={`flex-1 bg-slate-50 relative overflow-hidden flex flex-col ${viewMode === 'minimized' ? 'hidden' : 'block'}`}>
                                    <div className="flex-1 overflow-auto w-full h-full flex items-center justify-center p-4">
                                        {activeDoc.type === 'pdf' ? (
                                            <object data={activeDoc.url} type="application/pdf" className="w-full h-full min-h-[50vh] bg-white rounded-lg shadow-sm border border-slate-200">
                                                <div className="flex flex-col items-center justify-center h-full text-center p-6 bg-white rounded-xl shadow-lg">
                                                    <FileText size={64} className="text-[#4A6FA5] mb-4" />
                                                    <p className="text-xl font-bold text-[#2C3E50] mb-2">미리보기 제한</p>
                                                    <p className="text-slate-500 mb-6 text-sm">보안상의 이유로 모바일 미리보기가 제한될 수 있습니다.</p>
                                                    <a href={activeDoc.url} download={activeDoc.fileName} className="bg-[#4A6FA5] text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-[#3B5B8C]"><Download size={20} /> 파일 열기</a>
                                                </div>
                                            </object>
                                        ) : (
                                            <img src={activeDoc.url} alt="상세" className="max-w-full max-h-full object-contain rounded-lg shadow-lg" />
                                        )}
                                    </div>
                                    <div className="bg-white border-t border-slate-200 p-4 flex justify-between items-center shrink-0">
                                        <span className="text-sm font-bold text-slate-500 truncate max-w-[150px]">{activeDoc.fileName || '첨부파일'}</span>
                                        <a href={activeDoc.url} download={activeDoc.fileName || "download"} className="flex items-center gap-2 bg-[#F0F2F5] text-[#2C3E50] px-4 py-3 rounded-xl font-bold hover:bg-slate-200 transition-colors no-underline text-sm"><Download size={18} /> 저장하기</a>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
